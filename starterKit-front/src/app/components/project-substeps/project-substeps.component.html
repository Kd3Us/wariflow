<div class="substeps-container">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold text-gray-800">Sous-étapes du projet</h3>
    <button
      type="button"
      (click)="toggleForm()"
      class="flex items-center gap-2 bg-secondary text-white px-3 py-2 rounded-md font-medium hover:bg-primary-light transition-colors"
      [disabled]="isLoading"
    >
      <span class="material-icons text-sm">{{ showForm ? 'close' : 'add' }}</span>
      {{ showForm ? 'Annuler' : 'Ajouter sous-étape' }}
    </button>
  </div>

  <div *ngIf="showForm" class="substep-form bg-gray-50 p-4 rounded-lg mb-4" (click)="$event.stopPropagation()">
    <form [formGroup]="subStepForm" (ngSubmit)="onSubmit()">
      <div class="form-group">
        <label for="title">Titre de la sous-étape *</label>
        <input 
          type="text" 
          id="title" 
          formControlName="title" 
          placeholder="Ex: Créer la base de données"
          [disabled]="isLoading"
        >
        <div class="error-message" *ngIf="subStepForm.get('title')?.invalid && subStepForm.get('title')?.touched">
          Le titre est obligatoire (minimum 3 caractères)
        </div>
      </div>

      <div class="form-group">
        <label for="description">Description</label>
        <textarea 
          id="description" 
          formControlName="description" 
          rows="2" 
          placeholder="Description optionnelle de la sous-étape"
          [disabled]="isLoading"
        ></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-secondary" (click)="toggleForm()" [disabled]="isLoading">
          Annuler
        </button>
        <button 
          type="button" 
          class="btn-primary" 
          [disabled]="subStepForm.invalid || isLoading" 
          (click)="onSubmit()"
        >
          <span *ngIf="isLoading" class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>
          {{ isLoading ? 'Ajout...' : 'Ajouter' }}
        </button>
      </div>
    </form>
  </div>

  <div class="substeps-list">
    <div *ngIf="subSteps.length === 0 && !isLoading" class="text-center py-8 text-gray-500">
      <span class="material-icons text-4xl mb-2 text-gray-300">checklist</span>
      <p>Aucune sous-étape pour ce projet</p>
    </div>

    <div *ngIf="isLoading && subSteps.length === 0" class="text-center py-8">
      <div class="animate-spin inline-block w-8 h-8 border-4 border-secondary border-t-transparent rounded-full"></div>
      <p class="mt-2 text-gray-500">Chargement...</p>
    </div>

    <div *ngFor="let subStep of sortedSubSteps" class="substep-card mb-3">
      <div class="flex items-start gap-3 p-4 bg-white border border-gray-200 rounded-lg">
        <input
          type="checkbox"
          [checked]="subStep.isCompleted"
          (change)="toggleCompletion(subStep)"
          class="w-4 h-4 text-secondary bg-gray-100 border-gray-300 rounded mt-1"
          [disabled]="isLoading"
        />

        <div class="flex-1">
          <h4 
            class="font-medium text-gray-900 mb-1"
            [class.line-through]="subStep.isCompleted"
            [class.text-gray-500]="subStep.isCompleted"
          >
            {{ subStep.title }}
          </h4>

          <p 
            *ngIf="subStep.description" 
            class="text-sm text-gray-600 mb-2"
            [class.line-through]="subStep.isCompleted"
          >
            {{ subStep.description }}
          </p>

          <div class="flex items-center gap-4 text-xs text-gray-500">
            <span class="flex items-center gap-1">
              <span class="material-icons text-sm">schedule</span>
              Étape {{ subStep.order + 1 }}
            </span>
            <span class="flex items-center gap-1">
              <span class="material-icons text-sm">event</span>
              {{ subStep.createdAt | date:'dd/MM/yyyy' }}
            </span>
          </div>
        </div>

        <button
          type="button"
          (click)="deleteSubStep(subStep)"
          class="p-1 rounded-full hover:bg-gray-100 text-gray-400 hover:text-red-500 transition-colors"
          [disabled]="isLoading"
        >
          <span class="material-icons text-lg">delete_outline</span>
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="subSteps.length > 0" class="progress-summary mt-4 p-3 bg-gray-50 rounded-lg">
    <div class="flex justify-between items-center text-sm mb-2">
      <span class="text-gray-600">Progression : {{ completedCount }}/{{ subSteps.length }} sous-étapes</span>
      <span class="text-secondary font-medium">{{ completionPercentage }}%</span>
    </div>
    <div class="w-full bg-gray-200 rounded-full h-2">
      <div 
        class="bg-secondary h-2 rounded-full transition-all duration-300"
        [style.width.%]="completionPercentage"
      ></div>
    </div>
  </div>
</div>